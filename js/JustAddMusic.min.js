"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var s=0;s<e.length;s++){var i=e[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,s,i){return s&&t(e.prototype,s),i&&t(e,i),e}}(),JustAddMusic=function(){function t(e){_classCallCheck(this,t),e&&"string"!=typeof e||(e={src:e}),this.mode=e.mode||0,this.gain=e.gain||1,this.onstart=e.onstart,this.ontick=e.ontick,this.onprogress=e.onprogress,this.label=e.label||"",this._paused=!!e.paused,this._keyControl=!1,this._tickInterval=0,this._tickIntervalID=0,this._request=null,this._playT=0,this._pausedT=0,this._ui=!1,this._uiDiv=null,this._audioData=null,this._deltaT=e.deltaT||50,this._avgT=e.avgT||150,this._maxT=Math.max(this._deltaT,this._avgT),this._context=null,this._gainNode=null,this._sourceNode=null,this._buffer=null,this._bound_handleKeyDown=this._handleKeyDown.bind(this),this._initAudio(),this._initUI(),this._initDropTarget(e.dropTarget),this.tickInterval=e.tickInterval,this.loadAudio(e.src),this.ui=void 0===e.ui||e.ui,this.keyControl=void 0===e.keyControl||e.keyControl,this.volume=void 0===e.volume?1:e.volume}return _createClass(t,[{key:"loadAudio",value:function(t){if(this.abort(),t){this._updateLoadUI(0);var e=this._request=new XMLHttpRequest;e.open("GET",t,!0),e.responseType="arraybuffer",e.addEventListener("load",this._handleURILoad.bind(this)),e.addEventListener("progress",this._handleURIProgress.bind(this)),e.send()}}},{key:"abort",value:function(){this._request&&this._request.abort(),this._request=null}},{key:"play",value:function(){var t=(this._sourceNode&&this._sourceNode.buffer)!==this._buffer,e=this._pausedT;this.pause();var s=this._sourceNode=this._context.createBufferSource();s.buffer=this._buffer,s.connect(this._gainNode),s.start(0,e),this._playT=this._context.currentTime-e,this._paused=!1,t&&this.onstart&&this.onstart()}},{key:"pause",value:function(){this._sourceNode&&!this._paused&&(this._sourceNode.stop(),this._sourceNode.disconnect(),this._sourceNode=null,this._pausedT=this._context.currentTime-this._playT,this._paused=!0)}},{key:"stop",value:function(){this.abort(),this.pause(),this._pausedT=this._playT=0}},{key:"skip",value:function(t){this._buffer&&(this._paused?this._pausedT+=t:(this._pausedT=Math.min(this._buffer.duration,Math.max(0,this._context.currentTime-this._playT+t)),this.play()))}},{key:"tick",value:function(){if(this._sourceNode&&(this._updateTimeUI(),this.ontick||!this._tickIntervalID)){!this._analyserNode&&this._initAnalyser();var t=this._freqData,e=this.mode,s=(new Date).getTime(),i=0,a=void 0,n=void 0;for(this._analyserNode.getByteTimeDomainData(t),a=0,n=t.length;a<n;a++){var o=t[a]/128-1;o<0&&(o*=-1),1===e?i+=o*o:2===e?i+=o:o>i&&(i=o)}1===e?i=Math.sqrt(i/n):2===e&&(i/=n),i=1-Math.pow(1-i,this.gain),i>1&&(i=1);var r=this._audioData,h={vol:i,t:s};r.unshift(h);var u=i,d=1,l=r[1];for(a=1,n=r.length;a<n;a++){var c=r[a];c.t>=s-this._avgT&&(u+=c.vol,d++),c.t>=s-this._deltaT&&(l=c),c.t<s-this._maxT&&(r.pop(),n--)}return h.avg=u/d,h.delta=l?i-l.vol:0,h.avgDelta=l?h.avg-l.avg:0,h.bass=Math.abs(this._compressorBass.reduction)/12,h.treble=Math.abs(this._compressorTreble.reduction)/12,h.optical=Math.abs(this._compressorBass.reduction+this._compressorTreble.reduction)/12,this.ontick&&this.ontick(h),h}}},{key:"toString",value:function(){return"[JustAddMusic]"}},{key:"_initAudio",value:function(){this._context=new(window.AudioContext||window.webkitAudioContext),this._gainNode=this._context.createGain(),this._gainNode.connect(this._context.destination),this._mute=this._context.createGain(),this._mute.gain.value=0,this._mute.connect(this._context.destination),this._compressorBass=this._context.createDynamicsCompressor(),this._compressorBass.threshold.value=-36,this._compressorBass.ratio.value=2,this._compressorBass.attack.value=0,this._compressorBass.release.value=.1,this._compressorBass.connect(this._mute),this._bandpassBass=this._context.createBiquadFilter(),this._bandpassBass.type="bandpass",this._bandpassBass.frequency.value=125,this._bandpassBass.connect(this._compressorBass),this._gainNode.connect(this._bandpassBass),this._compressorTreble=this._context.createDynamicsCompressor(),this._compressorTreble.threshold.value=-36,this._compressorTreble.ratio.value=2,this._compressorTreble.attack.value=0,this._compressorTreble.release.value=.05,this._compressorTreble.connect(this._mute),this.bamdpassTreble=this._context.createBiquadFilter(),this.bamdpassTreble.type="bandpass",this.bamdpassTreble.frequency.value=1500,this.bamdpassTreble.connect(this._compressorTreble),this._gainNode.connect(this.bamdpassTreble)}},{key:"_initAnalyser",value:function(){if(!this._analyserNode){var t=this._context;this._audioData=[],this._analyserNode=t.createAnalyser(),this._analyserNode.fftSize=128,this._analyserNode.smoothingTimeConstant=0,this._analyserNode.connect(t.destination),this._gainNode.disconnect(),this._gainNode.connect(this._bandpassBass),this._gainNode.connect(this.bamdpassTreble),this._gainNode.connect(this._analyserNode),this._freqData=new Uint8Array(this._analyserNode.frequencyBinCount)}}},{key:"_initDropTarget",value:function(t){void 0===t&&(t=window),"string"==typeof t&&(t=document.querySelector(t)),t&&(t.addEventListener("drop",this._handleDrop.bind(this)),t.addEventListener("dragenter",this._handleDragEnter.bind(this)),t.addEventListener("dragleave",this._handleDragLeave.bind(this)),t.addEventListener("dragover",this._handleDragOver.bind(this)),this._updateUI("drop an MP3 to play"))}},{key:"_decode",value:function(t){this._context.decodeAudioData(t,this._handleBufferDecode.bind(this)),this._updateUI("decoding...")}},{key:"_initUI",value:function(){(this._uiDiv=document.createElement("div")).className="jam-ui";var t=document.createElement("style");t.innerHTML=".jam-ui { padding: 0.75em; font-size: 10pt; font-family: arial, sans-serif; background: black; color: white; z-index: 100; position:absolute; bottom:0; left:0; letter-spacing: 0.02em }",document.head.insertBefore(t,document.head.firstChild)}},{key:"_updateLoadUI",value:function(t){this._updateUI(Math.round(100*t)+"%")}},{key:"_updateTimeUI",value:function(){if(this._buffer){var t=this._formatTime(Math.min(this._buffer.duration,this._context.currentTime-this._playT));t+=" / "+this._formatTime(this._buffer.duration),this._updateUI(t)}}},{key:"_formatTime",value:function(t){var e=t/60|0,s=Math.round(t-60*e);return e+":"+(s<10?"0":"")+s}},{key:"_updateUI",value:function(t){var e=this._uiDiv;e.style.display=t?"inline-block":"none",e.innerHTML=this.label+t}},{key:"_handleKeyDown",value:function(t){var e=t.key;if(" "===e)this.paused=!this.paused;else if("Enter"===e)this._pausedT=0,this.play();else if("ArrowUp"===e||"ArrowDown"===e)this.volume+=.1*("ArrowUp"===e?1:-1);else if("ArrowLeft"===e||"ArrowRight"===e){var s=("ArrowLeft"===e?-1:1)*(t.shiftKey?15:5)*(t.altKey?12:1);this.skip(s)}}},{key:"_handleDragEnter",value:function(t){this._handleDragLeave(t);var e=t.currentTarget;(e===window?document.body:e).className+=" jam-drop"}},{key:"_handleDragLeave",value:function(t){t.preventDefault();var e=t.currentTarget,s=e===window?document.body:e;s.className=s.className.replace(/\b\s?jam-drop\b/,"")}},{key:"_handleDragOver",value:function(t){this._handleDragEnter(t)}},{key:"_handleDrop",value:function(t){this._handleDragLeave(t),this.abort();var e=new FileReader;e.addEventListener("load",this._handleDropLoad.bind(this)),e.readAsArrayBuffer(t.dataTransfer.files[0])}},{key:"_handleDropLoad",value:function(t){this._decode(t.target.result)}},{key:"_handleURILoad",value:function(t){this._decode(t.target.response),this._request=null}},{key:"_handleURIProgress",value:function(t){var e=t.loaded/t.total;this.onprogress&&this.onprogress(e),this._updateLoadUI(e)}},{key:"_handleBufferDecode",value:function(t){this._buffer=t,this._pausedT=0,this._playT=this._context.currentTime,this._updateTimeUI(),this._paused||this.play()}},{key:"paused",get:function(){return this._paused},set:function(t){t?this.pause():this.play()}},{key:"keyControl",get:function(){return this._keyControl},set:function(t){t=!!t,this._keyControl!==t&&(this._keyControl=t,t?document.addEventListener("keydown",this._bound_handleKeyDown):document.removeEventListener("keydown",this._bound_handleKeyDown))}},{key:"tickInterval",get:function(){return this._tickInterval},set:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:16;void 0!==this._tickIntervalID&&(clearInterval(this._tickIntervalID),this._tickIntervalID=null),t>0&&(this._tickIntervalID=setInterval(this.tick.bind(this),t))}},{key:"volume",get:function(){return this._gainNode.gain.value},set:function(t){this._gainNode.gain.value=Math.max(0,Math.min(2,t))}},{key:"ui",get:function(){return this._ui},set:function(t){if(t=!!t,this._ui!==t){this._ui=t;var e=this._uiDiv;t?document.body.appendChild(e):e.parentNode.removeChild(e)}}},{key:"audioData",get:function(){return this._audioData[0]||{vol:0,avg:0,delta:0,avgDelta:0,t:0}}}]),t}();JustAddMusic.PEAK=0,JustAddMusic.RMS=1,JustAddMusic.AVERAGE=2;